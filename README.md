# Hi-BDiSCO

## System Requirement 

The binary executables (under bin/ directory) are compiled to run on the popular `Linux CentOS 7, RedHat/Roky 7 and 8, Ubuntu 20 and 22` platforms. They work with both Intel and AMD CPUs. 

## Dependencies 

1) Monte Carlo (MC) simulation:

The binary `bin/chrom_ap1.x` for MC simulation requires `OpenMPI --version >= 4`

2) Brownian Dynamics (BD) simulation:

The binary `bin/code` for BD simulation requires Nvidia GPU V100 or A100, and the code is compiled with `cuda-11.6.2`.

Environment `cuda-11.6.2` can be obtained by downloading docker file `nvidia/cuda:11.6.2-runtime-ubuntu20.04` from Docker Hub, or install using conda `conda install -c "nvidia/label/cuda-11.6.2" cuda-toolkit`


3) Initial structure generation:

Python scripts under `src/` requires following libs:

```
pyBigWig 0.3.18  
cooler 0.8.11  
numpy 1.18.5  
```

## Data Input Preparation

1) Experimental data:

The experimental data are under `data/` directory (example data are provided).

For the example data:

-> `nucleosome_position.bed` is a bed file generated by DANPOS using MNase-seq data that contains the nucleosome positioning information.

-> `tail_acetylation.narrowPeak` is a narrowPeak file generated by MACS from Chip-seq data that contains the tail acetylation information.

-> `LH.bw` is a bigwig file of Chip-seq data that contains the linker histone information.

-> `Hi-C-sample.mcool` is a mcool file contains Micro-C contact data.

The users can replace these data with their own data of interest.

2) Inputs:

The inputs can be modified via `input.txt`:

For the default example:

`chr = chr18`                                                           -> chromosome number  
`start = 58110000`                                                      -> chromosome start  
`end = 58150000`                                                        -> chromosome end  
`nucleosome_position = data/nucleosome_position.bed`                    -> nucleosome position file location (optional, if not provided, life-like fiber will be generated)  
`tail_acetylation = data/tail_acetylation.narrowPeak`                   -> tail acetylation file location (optional, if not provided, wildtype tail will be used)  
`LH = data/LH.bw`                                                       -> linker histone file location (optional, if not provided, random occupancy of LH will be assigned based on the LH density)  
`LH_ratio = 0.5`                                                        -> linker histone density  
`Hi-C = data/Hi-C-sample.mcool`                                         -> Hi-C-like map location  
`Hi-C-path = /resolutions/50`                                           -> path name of the Hi-C-like map file  
`N_rep = 1000`                                                          -> number of replicas to distribute restraints  
`N_sim = 100`                                                           -> number of simulations to be performed  

## Run simulation 

After modifying the data inputs, the users can run Hi-BDiSCO by executing the following shell scripts:

1) `./file_preparation.sh`                                              -> Prepare the input files for MC and BD code based on the provided experimental files

2) `./run_part1_initial_structure_generation.sh`                        -> Perform MC simulations to generate N_sim numbers of random initial structures (submitting HPC jobs, output/org_sys/mc/sub_batch.s should be modified accordingly)

3) `./run_part2_BD_reconstruction.sh`                                   -> Perform BD simulations to fold the target region of chromosome based on the Hi-C restraints (submitting HPC jobs, output/org_sys/bd/run-code.sbatch should be modified accordingly)

4) `./run_part3_MC_subsequent_simulation.sh`                            -> Perform MC simulations to take into account the effects of tail acetylation, linker histone, etc., and solve spatial problems (submitting HPC jobs, output/org_sys/mc/sub_batch.s should be modified accordingly)


## Outputs

The structures after each step are all stored.

The initial N_sim random structures are under `output/simulation/random_ini/`, with subfolders named copy_1 to copy_N (N=N_sim). The `snapshot.pdb` under these folders are the initial random structures in `PDB` format.

The structures after BD simulations are under `output/simulation/BD/`. Likewise, there are copy_1 to copy_N subfolders, and `out.xyz` are the structures after BD in `XYZ` format.

The structures after MC simulations are under `output/simulation/MC/`. The `snapshot.pdb` under copy_1 to copy_N subfolders are the final reconstructed structures in `PDB` format.
